define(["require","framework/controllers/Controller","framework/ViewRenderer","jquery","libs/external/select2","libs/external/highcharts","app/libs/DistrictDataFeed","app/libs/DeoDataFeed","app/libs/DeoAnalyticsDataFeed","text!app/views/district.html","text!app/views/deo.html","text!app/views/deo_name_tab.html"],function(e){var t=e("framework/controllers/Controller"),n=e("framework/ViewRenderer"),r=e("jquery"),i=e("libs/external/select2"),s=e("libs/external/highcharts"),o=e("app/libs/DistrictDataFeed"),u=e("app/libs/DeoDataFeed"),a=e("app/libs/DeoAnalyticsDataFeed"),f=e("text!app/views/district.html"),l=e("text!app/views/deo.html"),c=e("text!app/views/deo_name_tab.html"),h=t.extend({constructor:function(e){return this.base(e),this.initSelect2(),this},_initReferences:function(e){this.base();var t=this._references;t.districtdataFeed=new o,t.deodataFeed=new u,t.analyticsdataFeed=new a,t.$analyticsWrapper=e,t.$districtContainer=e.find(".js-district-container"),t.$deoContainer=e.find(".js-deo-container"),t.$deoTabContainer=e.find(".js-deo-tab-container"),t.$goButton=e.find(".js-go-btn"),t.$dayTab=e.find(".js-daily-tab"),t.$weekTab=e.find(".js-weekly-tab"),t.$monthTab=e.find(".js-monthly-tab"),t.$prevPointer=e.find(".js-prev-pointer"),t.$nextPointer=e.find(".js-next-pointer"),t.$partnerList=e.find(".js-partnerlist")},_initEvents:function(){this.base();var e=this._boundFunctions,t=this._references;e.onDistrictDataProcessed=this._onDistrictDataProcessed.bind(this),t.districtdataFeed.on("dataProcessed",e.onDistrictDataProcessed),e.onDeoDataProcessed=this._onDeoDataProcessed.bind(this),t.deodataFeed.on("dataProcessed",e.onDeoDataProcessed),e.onAnalyticsDataProcessed=this._onAnalyticsDataProcessed.bind(this),t.analyticsdataFeed.on("dataProcessed",e.onAnalyticsDataProcessed),e.onGoBtnClick=this._onGoBtnClick.bind(this),t.$goButton.on("click",e.onGoBtnClick),e.onDayTabClick=this._onDayTabClick.bind(this),t.$dayTab.on("click",e.onDayTabClick),e.onWeekTabClick=this._onWeekTabClick.bind(this),t.$weekTab.on("click",e.onWeekTabClick),e.onMonthTabClick=this._onMonthTabClick.bind(this),t.$monthTab.on("click",e.onMonthTabClick),e.onPrevPointerClick=this._onPrevPointerClick.bind(this),t.$prevPointer.on("click",e.onPrevPointerClick),e.onNextPointerClick=this._onNextPointerClick.bind(this),t.$nextPointer.on("click",e.onNextPointerClick),e.onPartnerChosen=this._onPartnerChosen.bind(this),t.$partnerList.on("change",this._boundFunctions.onPartnerChosen)},setDate:function(e,t){var n=this._references;e==-1?t.setDate(t.getDate()-1):e==1&&t.setDate(t.getDate()+1);var i=t.getDate();n.days=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],n.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var s=n.days[t.getDay()],o=n.months[t.getMonth()],u=t.getFullYear();i<10&&(i="0"+i),t=s+" "+i+" "+o+" "+u,r("div#dateshow").html(t)},setWeekSingleDate:function(e){var t=e.getDay(),n=new Date(e),r=new Date(e);t==0?(n.setDate(e.getDate()-6),r.setDate(e.getDate())):t==1?(n.setDate(e.getDate()),r.setDate(e.getDate()+6)):t==2?(n.setDate(e.getDate()-1),r.setDate(e.getDate()+5)):t==3?(n.setDate(e.getDate()-2),r.setDate(e.getDate()+4)):t==4?(n.setDate(e.getDate()-3),r.setDate(e.getDate()+3)):t==5?(n.setDate(e.getDate()-4),r.setDate(e.getDate()+2)):t==6&&(r.setDate(e.getDate()+1),n.setDate(e.getDate()-5)),this.setWeekTwoDates(0,n,r)},setWeekTwoDates:function(e,t,n){var r=this._references;e==-1?(t.setDate(t.getDate()-7),n.setDate(n.getDate()-7)):e==1&&(t.setDate(t.getDate()+7),n.setDate(n.getDate()+7));var i=r.months[t.getMonth()],s=r.months[n.getMonth()],o=t.getFullYear(),u=n.getFullYear(),a=t.getDate()+" "+i+" "+o+"-"+n.getDate()+" "+s+" "+o;$("div#dateshow").html(a)},setMonthDate:function(e){var t=this._references,n=t.months[e.getMonth()],r=e.getFullYear();e=n+" "+r,$("div#dateshow").html(e)},getScreenDate:function(e){var t=this._references,n=r("#dateshow").html(),i=n.split(" "),s=i[1],o=i[3],u=t.months.indexOf(i[2]);e==2&&(u+=1),u<10&&(u="0"+u);var a;return e==1?a=new Date(o,u,s):e==2?a=o+"-"+u+"-"+s:e==3&&(a=new Date(o,u,s),a.setDate(a.getDate()+1),o=a.getFullYear(),u=a.getMonth()+1,u<10&&(u="0"+u),s=a.getDate(),a=o+"-"+u+"-"+s),a},getScreenWeekDate:function(e,t){var n=this._references,r=t.split(" "),i=r[0],s=r[2],o=n.months.indexOf(r[1]);e==2&&(o+=1),o<10&&(o="0"+o);var u;return e==1?u=new Date(s,o,i):e==2&&(u=s+"-"+o+"-"+i),u},getMonthFirstDate:function(e){var t=this._references,n=r("#dateshow").html(),i=n.split(" "),s=new Date(i[1],t.months.indexOf(i[0]),"01");if(e==2){var o=s.getMonth()+1;s=s.getFullYear()+"-"+o+"-"+s.getDate()}return s},getMonthLastDate:function(){var e=this.getMonthFirstDate(1),t=new Date(e.getFullYear(),e.getMonth()+1,0),n=t.getMonth()+1,t=t.getFullYear()+"-"+n+"-"+t.getDate();return t},setDay:function(){var e=this._references,t=r("#dateshow").html(),n=t.split(" ");if(n[0]==parseInt(n[0])){var i=t.split("-"),s=this.getScreenWeekDate(1,i[0]);this.setDate(0,s)}else if(r.inArray(n[0],e.months)>=0){var o=this.getMonthFirstDate(1),u=e.days[o.getDay()],a=e.months[o.getMonth()];o=u+" "+o.getDate()+" "+a+" "+o.getFullYear(),$("div#dateshow").html(o)}},setWeek:function(){var e=this._references,t=r("#dateshow").html(),n=t.split(" ");if(r.inArray(n[0],e.days)>=0){var i=this.getScreenDate(1);this.setWeekSingleDate(i)}else if(r.inArray(n[0],e.months)>=0){var s=this.getMonthFirstDate(1);this.setWeekSingleDate(s)}},setMonth:function(){var e=this._references,t=r("#dateshow").html(),n=t.split(" ");if(r.inArray(n[0],e.days)>=0){var i=this.getScreenDate(1);this.setMonthDate(i)}else if(n[0]==parseInt(n[0])){var s=t.split("-"),o=this.getScreenWeekDate(1,s[1]);this.setMonthDate(o)}},getDistrict:function(){var e=this._references.districtdataFeed.getDistrict();if(e==0)return!1;this._renderDistrict(e),this.initSelect2()},getDeo:function(){var e=this._references.deodataFeed.getDeo();if(e==0)return!1;this._renderDeo(e),this.initSelect2()},getAnalytics:function(){var e=this._references.analyticsdataFeed.getAnalytics();if(e==0)return!1;var t=this._references.datelist,n=this._references.s_list,r=this._references.a_list,i=0,s=0;if(e.mode==1){for(var o in e.screenings)n[0]=e.screenings[o],i+=e.screenings[o];for(var u in e.adoptions)r[0]=e.adoptions[u],s+=e.adoptions[u]}if(e.mode==2){for(var o in e.screenings){var a=o.split("-")[2];a=a.replace(/^0+/,"");for(var f=0;f<=6;f++)t[f].split(" ")[0]==a&&(n[f]=e.screenings[o]);i+=e.screenings[o]}for(var u in e.adoptions){var a=u.split("-")[2];a=a.replace(/^0+/,"");for(var f=0;f<=6;f++)t[f].split(" ")[0]==a&&(r[f]=e.adoptions[u]);s+=e.adoptions[u]}}if(e.mode==3){for(var o in e.screenings){var a=o.split("-")[2];a=a.replace(/^0+/,""),n[a-1]=e.screenings[o],i+=e.screenings[o]}for(var u in e.adoptions){var a=u.split("-")[2];a=a.replace(/^0+/,""),r[a-1]=e.adoptions[u],s+=e.adoptions[u]}}var l=i,c=s,h=e.persons;if(e.slag=="NA")var p=e.slag;else var p=e.slag+" days";if(e.alag=="NA")var d=e.alag;else var d=e.alag+" days";$("p#screenings").html(l),$("p#adoptions").html(c),$("p#persons").html(h),$("p#s-lag").html(p),$("p#a-lag").html(d),this.makeChart(t,n,r)},analyzeDeo:function(){var e=this._references,t,n=[],i=[],s=[];if($("#daily").hasClass("active")==1){t=1;var o=this.getScreenDate(2),u=this.getScreenDate(3);n.push(0),i.push(0);var a=this.getScreenDate(1),f=a.getDate(),l=e.months[a.getMonth()];v=f+" "+l,s.push(v)}else if($("#weekly").hasClass("active")==1){t=2;var c=r("#dateshow").html(),h=c.split("-"),o=this.getScreenWeekDate(2,h[0]),u=this.getScreenWeekDate(2,h[1]),p=this.getScreenWeekDate(1,h[0]);for(var d=0;d<=6;d++){n.push(0),i.push(0);var f=p.getDate(),l=e.months[p.getMonth()],v=f+" "+l;s.push(v),p.setDate(p.getDate()+1)}}else if($("#monthly").hasClass("active")==1){var c=r("#dateshow").html(),m=c.split(" "),l=m[0];t=3;var o=this.getMonthFirstDate(2),u=this.getMonthLastDate(),g=u.split("-")[2];for(var d=1;d<=g;d++)s.push(d),i.push(0),n.push(0)}e.analyticsdataFeed.addInputParam("limit",!1,0),e.analyticsdataFeed.setInputParam("limit",0,!1),e.analyticsdataFeed.addInputParam("deo",!1,e.$selectedDeo),e.analyticsdataFeed.setInputParam("deo",e.$selectedDeo,!1),e.analyticsdataFeed.addInputParam("sdate",!1,o),e.analyticsdataFeed.setInputParam("sdate",o,!1),e.analyticsdataFeed.addInputParam("edate",!1,u),e.analyticsdataFeed.setInputParam("edate",u,!1),e.analyticsdataFeed.addInputParam("mode",!1,t),e.analyticsdataFeed.setInputParam("mode",t,!1),e.datelist=s,e.a_list=i,e.s_list=n,this.getAnalytics()},makeChart:function(e,t,n){var r=new Highcharts.Chart({chart:{renderTo:"chartcontainer"},title:{text:"DEO Performance",x:-20},xAxis:{categories:e},yAxis:{title:{text:"Entries made"},plotLines:[{value:0,width:1,color:"#808080"}]},plotOptions:{series:{cursor:"pointer",point:{events:{click:function(){if($("#weekly").hasClass("active")==1){var e=document.getElementById("dateshow").innerHTML,t=e.split("-"),n=t[0].split(" "),r=n[2];curdate=this.category;var i=curdate.split(" ")[0],s=curdate.split(" ")[1],o=getmonthnofromname(s);i<10&&(i="0"+i),o<10&&(o="0"+o);var u=new Date(r,o,i);makeactive(1),setdate(0,u),analyzedeo()}else if($("#monthly").hasClass("active")==1){var e=document.getElementById("dateshow").innerHTML,a=e.split(" "),s=a[0],r=a[1],o=getmonthnofromname(s);o<10&&(o="0"+o);var i=this.category;i<10&&(i="0"+i);var u=new Date(r,o,i);makeactive(1),setdate(0,u),analyzedeo()}}}}}},series:[{name:"Screenings",data:t},{name:"Adoptions",data:n}]})},_onDistrictDataProcessed:function(){this.getDistrict()},_onDeoDataProcessed:function(){this.getDeo()},_onAnalyticsDataProcessed:function(){this.getAnalytics()},_onGoBtnClick:function(e){e.preventDefault();var t=this._references;r("#deolist").addClass("nodisplay"),r("#thegrid").removeClass("hidden"),r("#deobox").removeClass("hidden");var n=[];t.$deoList.find(":selected").each(function(){n.push({deo_id:r(this).val(),deo_name:r(this).text()})}),console.log(n),this._renderDeoTab(n),t.$deoList.val([]),this.initSelect2(),this.analyzeDeo()},_onDayTabClick:function(e){e.preventDefault();var t=this._references;t.$dayTab.addClass("active"),t.$weekTab.removeClass("active"),t.$monthTab.removeClass("active"),this.setDay(),this.analyzeDeo()},_onWeekTabClick:function(e){e.preventDefault();var t=this._references;t.$dayTab.removeClass("active"),t.$weekTab.addClass("active"),t.$monthTab.removeClass("active"),this.setWeek(),this.analyzeDeo()},_onMonthTabClick:function(e){e.preventDefault();var t=this._references;t.$dayTab.removeClass("active"),t.$weekTab.removeClass("active"),t.$monthTab.addClass("active"),this.setMonth(),this.analyzeDeo()},_onNextPointerClick:function(e){e.preventDefault();if($("#daily").hasClass("active")==1)this.setDate(1,this.getScreenDate(1));else if($("#weekly").hasClass("active")==1){var t=r("#dateshow").html(),n=t.split("-"),i=this.getScreenWeekDate(1,n[0]),s=this.getScreenWeekDate(1,n[1]);this.setWeekTwoDates(1,i,s)}else if($("#monthly").hasClass("active")==1){var o=this.getMonthFirstDate(1);o.setMonth(o.getMonth()+1),this.setMonthDate(o)}this.analyzeDeo()},_onPrevPointerClick:function(e){e.preventDefault();if($("#daily").hasClass("active")==1)this.setDate(-1,this.getScreenDate(1));else if($("#weekly").hasClass("active")==1){var t=r("#dateshow").html(),n=t.split("-"),i=this.getScreenWeekDate(1,n[0]),s=this.getScreenWeekDate(1,n[1]);this.setWeekTwoDates(-1,i,s)}else if($("#monthly").hasClass("active")==1){var o=this.getMonthFirstDate(1);o.setMonth(o.getMonth()-1),this.setMonthDate(o)}this.analyzeDeo()},_renderDistrict:function(e){var t=this._references,i={district:e},s=n.render(f,i);this._references.$districtContainer.html(s),t.$districtList=r(".js-districtlist"),this._boundFunctions.onDistrictChosen=this._onDistrictChosen.bind(this),t.$districtList.on("change",this._boundFunctions.onDistrictChosen)},_renderDeo:function(e){var t=this._references,i={deo:e},s=n.render(l,i);this._references.$deoContainer.html(s),t.$deoList=r(".js-deolist")},_renderDeoTab:function(e){var t=this._references,i={deo:e},s=n.render(c,i);t.$deoTabContainer.html(s),t.$deoTabContainer.find("li:first a").addClass("active"),t.$selectedDeo=t.$deoTabContainer.find("li:first a").attr("id");var o=this;t.$deoTabContainer.find("li").click(function(e){t.$deoTabContainer.find("li").each(function(e){r(this).find("a").removeClass("active")}),r(this).find("a").addClass("active"),t.$selectedDeo=r(this).find("a").attr("id"),o.analyzeDeo()})},initSelect2:function(){var e=this._references;try{$(".chosen-select").select2({no_results_text:"No results match",width:"100%",placeholder:"Choose Username"})}catch(t){$("select.chosen-select").select2({no_results_text:"No results match",width:"100%",placeholder:"Choose Username"})}},_onPartnerChosen:function(){var e=this._references;e.$partnerList.val()!=""&&(e.districtdataFeed.addInputParam("limit",!1,0),e.districtdataFeed.setInputParam("limit",0,!1),e.districtdataFeed.addInputParam("partner",!1,e.$partnerList.val()),e.districtdataFeed.setInputParam("partner",e.$partnerList.val(),!1),this.getDistrict())},_onDistrictChosen:function(){var e=this._references;e.$districtList.val()!=""&&(e.deodataFeed.addInputParam("limit",!1,0),e.deodataFeed.setInputParam("limit",0,!1),e.deodataFeed.addInputParam("partner",!1,e.$partnerList.val()),e.deodataFeed.setInputParam("partner",e.$partnerList.val(),!1),e.deodataFeed.addInputParam("district",!1,e.$districtList.val()),e.deodataFeed.setInputParam("district",e.$districtList.val(),!1),this.getDeo())},setInputParam:function(e,t,n){this._references.dataFeed.setInputParam(e,t,n)},_onInputParamChanged:function(){this.getCollectionDropDown()},destroy:function(){this.base()}});return h});