<!DOCTYPE html>

<html>
<head>
  <title>denormalize.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="auth.html">
                auth.js
              </a>
            
              
              <a class="source" href="auth_offline_backend.html">
                auth_offline_backend.js
              </a>
            
              
              <a class="source" href="upload_collection.html">
                upload_collection.js
              </a>
            
              
              <a class="source" href="configs.html">
                configs.js
              </a>
            
              
              <a class="source" href="convert_namespace.html">
                convert_namespace.js
              </a>
            
              
              <a class="source" href="denormalize.html">
                denormalize.js
              </a>
            
              
              <a class="source" href="indexeddb_backbone_config.html">
                indexeddb_backbone_config.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="user_model.html">
                user_model.js
              </a>
            
              
              <a class="source" href="offline_utils.html">
                offline_utils.js
              </a>
            
              
              <a class="source" href="online_utils.html">
                online_utils.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="user_initialize.html">
                user_initialize.js
              </a>
            
              
              <a class="source" href="app_layout.html">
                app_layout.js
              </a>
            
              
              <a class="source" href="dashboard.html">
                dashboard.js
              </a>
            
              
              <a class="source" href="form.html">
                form.js
              </a>
            
              
              <a class="source" href="form_controller.html">
                form_controller.js
              </a>
            
              
              <a class="source" href="full_download.html">
                full_download.js
              </a>
            
              
              <a class="source" href="incremental_download.html">
                incremental_download.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="login.html">
                login.js
              </a>
            
              
              <a class="source" href="notification.html">
                notification.js
              </a>
            
              
              <a class="source" href="status.html">
                status.js
              </a>
            
              
              <a class="source" href="upload.html">
                upload.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>denormalize.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*takes an object and the foreign entities description for the object. Using the descrip iterates over json,
identifies the foreign values and denormalizes them. Same object passed is denormalised. New object is not created.*/</span>

define([<span class="string">'jquery'</span>, <span class="string">'configs'</span>, <span class="string">'backbone'</span>, <span class="string">'indexeddb_backbone_config'</span>],

<span class="keyword">function</span>($, configs, pa, indexeddb) {
    <span class="keyword">var</span> denormalize = {
        _get_id_field: <span class="keyword">function</span>(entity, element, f_entities) {
            <span class="keyword">return</span> f_entities[entity][element].id_field || <span class="string">"id"</span>;
        },

        _get_name_field: <span class="keyword">function</span>(entity, element, f_entities) {
            <span class="keyword">return</span> f_entities[entity][element].name_field;
        },

        denormalize: <span class="keyword">function</span>(json, f_entities) {
            console.log(<span class="string">"FORMCONTROLLER:denormalize: json before denormalizing"</span> + JSON.stringify(json));
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.field_dfds = [];
            <span class="keyword">this</span>._iterate_foreign_fields(json, f_entities);
            <span class="keyword">return</span> $.when.apply($,<span class="keyword">this</span>.field_dfds);
        },

        _iterate_foreign_fields: <span class="keyword">function</span>(json, f_entities) {
            <span class="keyword">for</span> (<span class="keyword">var</span> entity <span class="keyword">in</span> f_entities) {
                <span class="keyword">for</span> (<span class="keyword">var</span> element <span class="keyword">in</span> f_entities[entity]) {
                    <span class="keyword">var</span> id_field = <span class="keyword">this</span>._get_id_field(entity, element, f_entities);
                    <span class="keyword">var</span> name_field = <span class="keyword">this</span>._get_name_field(entity, element, f_entities);
                    <span class="keyword">var</span> field_desc = {
                        entity_name: entity,
                        id_attribute: id_field,
                        name_attribute: name_field
                    };
                    
                    <span class="keyword">if</span> (!(json[element])) 
                    {
                        json[element] = {};
                        json[element][field_desc.id_attribute] = <span class="literal">null</span>;
                        json[element][field_desc.name_attribute] = <span class="literal">null</span>;
                        <span class="keyword">continue</span>;
                    }
                    
                    <span class="keyword">if</span>(f_entities[entity][element].expanded)
                    {
                        <span class="keyword">if</span> (f_entities[entity][element].expanded.foreign_entities){</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>expanded contains foreign fields</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            _.each(json[element], <span class="keyword">function</span>(object, index) {
                                <span class="keyword">this</span>._iterate_foreign_fields(object, f_entities[entity][element].expanded.foreign_entities);
                            }, <span class="keyword">this</span>);
                        }
                        <span class="keyword">return</span>;
                    }
                        

                    <span class="keyword">if</span> (json[element] <span class="keyword">instanceof</span> Array) <span class="comment">//multi-select dropdown</span>
                    {
                        _.each(json[element], <span class="keyword">function</span>(val, index) {
                            json[element][index] = {};
                            json[element][index][id_field] = parseInt(val);
                            <span class="keyword">this</span>.field_dfds.push(<span class="keyword">this</span>._denormalize_object(json[element][index], field_desc));
                        }, <span class="keyword">this</span>);
                    }
                    <span class="keyword">else</span> <span class="comment">//single-select dropdown</span>
                    {
                        <span class="keyword">var</span> temp = {};
                        temp[id_field] = parseInt(json[element]);
                        json[element] = temp;
                        <span class="keyword">this</span>.field_dfds.push(<span class="keyword">this</span>._denormalize_object(json[element], field_desc));
                    }

                }
            }
        },

        _denormalize_object: <span class="keyword">function</span>(obj, field_desc) {
            console.log(<span class="string">"Denormalize: dnormalizing object"</span>, JSON.stringify(obj), JSON.stringify(field_desc));
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">if</span> (!obj[field_desc.id_attribute]){ 
                obj[field_desc.id_attribute] = <span class="literal">null</span>;
                obj[field_desc.name_attribute] = <span class="literal">null</span>;
                <span class="keyword">return</span> dfd.resolve();
            }
            <span class="keyword">var</span> generic_model_offline = Backbone.Model.extend({
                database: indexeddb,
                storeName: field_desc.entity_name,
            });
            <span class="keyword">var</span> f_model = <span class="keyword">new</span> generic_model_offline();
            f_model.set(<span class="string">"id"</span>, parseInt(obj[field_desc.id_attribute]));
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            f_model.fetch({
                success: <span class="keyword">function</span>(model) {
                    obj[field_desc.name_attribute] = model.get(field_desc.name_attribute);
                    <span class="keyword">return</span> dfd.resolve();
                },
                error: <span class="keyword">function</span>(model, error) {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO: OOPS! What should be done now????
alert(&quot;Denormalize: unexpected error. check console log &quot; + error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    console.log(<span class="string">"Denormalize: unexpected error.fetch failed"</span>,error);
                    <span class="keyword">return</span> dfd.reject(error);
                }
            });
            <span class="keyword">return</span> dfd.promise();
        }

    }


    <span class="keyword">return</span> denormalize;

});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
