<!DOCTYPE html>

<html>
<head>
  <title>incremental_download.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="auth.html">
                auth.js
              </a>
            
              
              <a class="source" href="auth_offline_backend.html">
                auth_offline_backend.js
              </a>
            
              
              <a class="source" href="upload_collection.html">
                upload_collection.js
              </a>
            
              
              <a class="source" href="configs.html">
                configs.js
              </a>
            
              
              <a class="source" href="convert_namespace.html">
                convert_namespace.js
              </a>
            
              
              <a class="source" href="denormalize.html">
                denormalize.js
              </a>
            
              
              <a class="source" href="indexeddb_backbone_config.html">
                indexeddb_backbone_config.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="user_model.html">
                user_model.js
              </a>
            
              
              <a class="source" href="offline_utils.html">
                offline_utils.js
              </a>
            
              
              <a class="source" href="online_utils.html">
                online_utils.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="user_initialize.html">
                user_initialize.js
              </a>
            
              
              <a class="source" href="app_layout.html">
                app_layout.js
              </a>
            
              
              <a class="source" href="dashboard.html">
                dashboard.js
              </a>
            
              
              <a class="source" href="form.html">
                form.js
              </a>
            
              
              <a class="source" href="form_controller.html">
                form_controller.js
              </a>
            
              
              <a class="source" href="full_download.html">
                full_download.js
              </a>
            
              
              <a class="source" href="incremental_download.html">
                incremental_download.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="login.html">
                login.js
              </a>
            
              
              <a class="source" href="notification.html">
                notification.js
              </a>
            
              
              <a class="source" href="status.html">
                status.js
              </a>
            
              
              <a class="source" href="upload.html">
                upload.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>incremental_download.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define([
  <span class="string">'jquery'</span>,
  <span class="string">'underscore'</span>,
  <span class="string">'layoutmanager'</span>,
  <span class="string">'indexeddb_backbone_config'</span>,
  <span class="string">'configs'</span>,
  <span class="string">'convert_namespace'</span>,
  <span class="string">'offline_utils'</span>, 
  <span class="string">'indexeddb-backbone'</span>,
  <span class="string">'bootstrapjs'</span>,
], <span class="keyword">function</span>(jquery,underscore,layoutmanager,indexeddb, all_configs, ConvertNamespace, Offline){
    
    <span class="keyword">var</span> IncrementalDownloadView = Backbone.Layout.extend({
        
        template: <span class="string">"#incremental_download_template"</span>,
        events:{
            <span class="string">"click #stop_inc_download"</span>: <span class="string">"stop_inc_download"</span>
        },
        increment_pb: <span class="keyword">function</span>() {
            w = parseFloat(document.getElementById(<span class="string">'inc_pbar'</span>).style.width);
            document.getElementById(<span class="string">'inc_pbar'</span>).style.width= (w + <span class="keyword">this</span>.progress_bar_step) +<span class="string">'%'</span>;
        },
        
        update_status: <span class="keyword">function</span>(status){
            console.log(status);
            $(<span class="string">'#inc_status'</span>).html(status);
        },
        
        update_action: <span class="keyword">function</span>(action){
            $(<span class="string">'#inc_action'</span>).html(action);
        },
        
        initialize: <span class="keyword">function</span>(){
            console.log(<span class="string">"UPLOAD: initializing new incremental_download view"</span>);
            _.bindAll(<span class="keyword">this</span>);
            <span class="keyword">this</span>.start_timestamp = <span class="literal">null</span>;
            <span class="keyword">this</span>.in_progress = <span class="literal">false</span>;
        },  
        
        stop_inc_download: <span class="keyword">function</span>(){
            console.log(<span class="string">"stopping inc download"</span>);
            <span class="keyword">this</span>.user_interrupt = <span class="literal">true</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>initializes the global vars used, ui</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        initialize_inc_download: <span class="keyword">function</span>(options){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">this</span>.in_progress = <span class="literal">true</span>;
            <span class="keyword">this</span>.user_interrupt = <span class="literal">false</span>;
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">if</span>(!(options.background))
            {
                <span class="keyword">this</span>.template = <span class="string">"#incremental_download_template"</span>;
                <span class="keyword">this</span>.render()
                    .done(<span class="keyword">function</span>(){
                        that.$(<span class="string">'#incremental_download_modal'</span>).modal({
                            keyboard: <span class="literal">false</span>,
                            backdrop: <span class="string">"static"</span>,
                        });
                        that.$(<span class="string">'#incremental_download_modal'</span>).on(<span class="string">'shown'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                            dfd.resolve();
                        });
                        that.$(<span class="string">'#incremental_download_modal'</span>).modal(<span class="string">'show'</span>);                    
                    });
            }
            <span class="keyword">else</span>
            {
                <span class="keyword">this</span>.template = <span class="string">"#incremental_download_background_template"</span>;
                <span class="keyword">this</span>.render()
                    .done(<span class="keyword">function</span>(){
                        dfd.resolve();
                    });
            }
            <span class="keyword">return</span> dfd.promise();
        },
        
        tear_down: <span class="keyword">function</span>(){
            <span class="keyword">this</span>.$(<span class="string">'#incremental_download_modal'</span>).modal(<span class="string">'hide'</span>);                    
            <span class="keyword">this</span>.remove();
            <span class="keyword">this</span>.in_progress = <span class="literal">false</span>;
        },
              
        start_incremental_download: <span class="keyword">function</span>(options) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">var</span> that = <span class="keyword">this</span>;        
            console.log(<span class="string">"INCREMENTAL DOWNLOAD: start the incremental_download"</span>);
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.initialize_inc_download(options) <span class="comment">//does not rejects dfd...may not resolve either!</span>
                .done(<span class="keyword">function</span>(){
                    that.getIncObjects()
                        .done(<span class="keyword">function</span>(objects){
                            that.iterate_incd_objects(objects)
                                .done(<span class="keyword">function</span>(last_object_timestamp){
                                    that.finish_download(last_object_timestamp)
                                        .done(<span class="keyword">function</span>(){
                                            that.tear_down();
                                            dfd.resolve();
                                        })
                                        .fail(<span class="keyword">function</span>(error){
                                            that.tear_down();
                                            dfd.reject(error);
                                        });
                                })
                                .fail(<span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>when user interrupts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="keyword">if</span>(error.last_object_timestamp)
                                    {
                                        that.finish_download(error.last_object_timestamp)
                                            .always(<span class="keyword">function</span>(){
                                                that.tear_down();
                                                dfd.reject(error.err_msg);
                                            });
                                    }
                                    dfd.reject(error.err_msg)
                                });
                        })
                        .fail(<span class="keyword">function</span>(error){
                            that.tear_down();
                            dfd.reject(error);
                        });
                });
            <span class="keyword">return</span> dfd;    
        },

        getIncObjects: <span class="keyword">function</span>(){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="comment">/*Recording the time when the request for update was sent, to update last_inc_downloaded ts if required.
            Django complains when Z is present in ts bcoz timezone capab is off*/</span>
            <span class="keyword">this</span>.start_timestamp = <span class="keyword">new</span> Date().toJSON().replace(<span class="string">"Z"</span>, <span class="string">""</span>);
            <span class="keyword">this</span>.get_last_download_timestamp()
                .done(<span class="keyword">function</span>(timestamp){
                    console.log(<span class="string">"Timestamp for inc download - "</span>+timestamp);
                    $.get(all_configs.misc.inc_download_url,{
                        timestamp:timestamp
                    }, <span class="keyword">function</span>(){},<span class="string">"json"</span>)
                        .fail(<span class="keyword">function</span>(){ 
                            dfd.reject(<span class="string">"Incremental download objects fetch failed!"</span>);
                        })
                        .done(<span class="keyword">function</span>(objects){
                            dfd.resolve(objects);
                        });
                })
                .fail(<span class="keyword">function</span>(error){
                    dfd.reject(error);
                });
            <span class="keyword">return</span> dfd;    
        },    
            
        get_last_download_timestamp: <span class="keyword">function</span>(){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            Offline.fetch_object(<span class="string">"meta_data"</span>, <span class="string">"key"</span>, <span class="string">"last_inc_download"</span>)
                .done(<span class="keyword">function</span>(model){
                    dfd.resolve(model.get(<span class="string">'timestamp'</span>));
                })
                .fail(<span class="keyword">function</span>(model, error){
                    Offline.fetch_object(<span class="string">"meta_data"</span>, <span class="string">"key"</span>, <span class="string">"last_full_download"</span>)
                        .done(<span class="keyword">function</span>(model){
                            dfd.resolve(model.get(<span class="string">'timestamp'</span>));
                        })
                        .fail(<span class="keyword">function</span>(model, error){
                            dfd.reject(<span class="string">"Neither inc download has happened before nor full download."</span>);
                        }); 
                });
            
            <span class="keyword">return</span> dfd;    
        },
            
        iterate_incd_objects: <span class="keyword">function</span>(incd_objects){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">this</span>.incd_objects = incd_objects;
            <span class="keyword">if</span>(!<span class="keyword">this</span>.incd_objects.length || <span class="keyword">this</span>.incd_objects==<span class="number">0</span>)
                <span class="keyword">return</span> dfd.resolve();
            <span class="keyword">this</span>.progress_bar_step = <span class="number">100</span>/incd_objects.length;
            <span class="keyword">this</span>.download_status = {};
            <span class="keyword">this</span>.download_status[<span class="string">"total"</span>] = incd_objects.length;
            <span class="keyword">this</span>.download_status[<span class="string">"downloaded"</span>] = <span class="number">0</span>;
            console.log(<span class="string">"INCD objects received"</span>);
            console.log(incd_objects);
            <span class="keyword">this</span>.pick_next(dfd);
            <span class="keyword">return</span> dfd;
        },  
        
        pick_next: <span class="keyword">function</span>(whole_download_dfd){
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.prev_incd_o = <span class="keyword">this</span>.cur_incd_o;
            <span class="keyword">this</span>.update_status(<span class="keyword">this</span>.download_status[<span class="string">"downloaded"</span>]+<span class="string">"/"</span>+<span class="keyword">this</span>.download_status[<span class="string">"total"</span>]);
            <span class="keyword">this</span>.cur_incd_o = <span class="keyword">this</span>.incd_objects.shift();
            <span class="keyword">if</span>(!<span class="keyword">this</span>.cur_incd_o)
            {
                <span class="keyword">var</span> update_timestamp;
                <span class="keyword">if</span>(<span class="keyword">this</span>.prev_incd_o)
                    update_timestamp = <span class="keyword">this</span>.get_timestamp(<span class="keyword">this</span>.prev_incd_o)
                <span class="keyword">else</span>
                    update_timestamp = <span class="keyword">this</span>.start_timestamp;    
                <span class="keyword">return</span> whole_download_dfd.resolve(update_timestamp);
            }
            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.user_interrupt)
            {
                <span class="keyword">var</span> update_timestamp;
                <span class="keyword">if</span>(<span class="keyword">this</span>.prev_incd_o)
                    update_timestamp = <span class="keyword">this</span>.get_timestamp(<span class="keyword">this</span>.prev_incd_o)
                <span class="keyword">else</span>
                    update_timestamp = <span class="literal">null</span>;
                <span class="keyword">return</span> whole_download_dfd.reject({
                    err_msg:<span class="string">"User stopped Sync"</span>, 
                    last_object_timestamp: update_timestamp
                });
            }
            <span class="keyword">else</span>
            {   
                <span class="keyword">this</span>.process_incd_object(<span class="keyword">this</span>.cur_incd_o)
                    .fail(<span class="keyword">function</span>(error){
                        console.log(<span class="string">"FAILED TO INC DOWNLOAD AN OBJECT: "</span>);
                        console.log(error);
                    })
                    .done(<span class="keyword">function</span>(){
                        console.log(<span class="string">"SUCESSFULLY DOWNLOADED AN OBJECT"</span>);
                    })
                    .always(<span class="keyword">function</span>(){
                        that.increment_pb();
                        that.download_status[<span class="string">"downloaded"</span>]++;
                        that.pick_next(whole_download_dfd);
                    });
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>{&quot;pk&quot;:9372,&quot;model&quot;:&quot;dashboard.serverlog&quot;,&quot;fields&quot;:{&quot;action&quot;:1,&quot;timestamp&quot;:&quot;2013-04-15T06:47:35&quot;,&quot;entry_table&quot;:&quot;Screening&quot;,&quot;model_id&quot;:10000000132086}}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get_timestamp: <span class="keyword">function</span>(obj){
            <span class="keyword">return</span> obj.fields.timestamp;
        },
        
        get_entity_name: <span class="keyword">function</span>(obj){
            <span class="keyword">for</span> (<span class="keyword">var</span> member <span class="keyword">in</span> all_configs) {
                <span class="keyword">if</span> (member == obj.fields.entry_table.toLowerCase())
                {
                    <span class="keyword">return</span> all_configs[member].entity_name;
                }
                <span class="keyword">else</span> <span class="keyword">if</span>((all_configs[member].inc_table_name)&amp;&amp;(all_configs[member].inc_table_name == obj.fields.entry_table.toLowerCase()))
                {
                    <span class="keyword">return</span> all_configs[member].entity_name;
                }
            }
            <span class="keyword">return</span> -<span class="number">1</span>;
        },
            
        get_action: <span class="keyword">function</span>(obj){
            <span class="keyword">return</span> obj.fields.action;
        },    
        
        get_online_id: <span class="keyword">function</span>(obj){
            <span class="keyword">return</span> parseInt(obj.fields.model_id);
        },
        
        get_foreign_field_desc: <span class="keyword">function</span>(obj){
            <span class="keyword">var</span> entity_name = <span class="keyword">this</span>.get_entity_name(obj);    
            <span class="keyword">if</span>(all_configs[entity_name].edit)
            {
                <span class="keyword">return</span> all_configs[entity_name].edit.foreign_entities;
            }
            <span class="keyword">else</span>
                <span class="keyword">return</span> all_configs[entity_name].foreign_entities;
        },    
                
        process_incd_object: <span class="keyword">function</span>(incd_o){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>console.log(&quot;INCD object received - &quot;+JSON.stringify(incd_o));
$.get(&quot;/get_log/&quot;,{timestamp:&quot;2012-03-10 12:06:04&quot;},function(){console.log(&quot;suc it&quot;);return dfd.resolve();});</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> generic_model_offline = Backbone.Model.extend({
                database: indexeddb,
                storeName: <span class="keyword">this</span>.get_entity_name(incd_o),
            });
            <span class="keyword">var</span> that = <span class="keyword">this</span>;    
            <span class="keyword">var</span> generic_model_online = Backbone.Model.extend({
                sync: Backbone.ajaxSync,
                url: <span class="keyword">function</span>() {
                    <span class="keyword">return</span> <span class="keyword">this</span>.id ? all_configs[that.get_entity_name(incd_o)].rest_api_url + <span class="keyword">this</span>.id + <span class="string">"/"</span> : all_configs[that.get_entity_name(incd_o)].rest_api_url;
                },
            });
                
            <span class="keyword">this</span>.offline_model = <span class="keyword">new</span> generic_model_offline();
            <span class="keyword">this</span>.online_model = <span class="keyword">new</span> generic_model_online();
            <span class="keyword">this</span>.update_action(<span class="string">"Downloading "</span>+<span class="keyword">this</span>.get_entity_name(incd_o));
            
            <span class="keyword">switch</span>(<span class="keyword">this</span>.get_action(incd_o))
                {
                    <span class="keyword">case</span> <span class="number">1</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>console.log(&quot;its add&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.incd_add(incd_o, dfd);
                    <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="number">0</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>console.log(&quot;its edit&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.incd_edit(incd_o, dfd);
                    <span class="keyword">break</span>;
                    <span class="keyword">case</span> -<span class="number">1</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>console.log(&quot;its delete&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">this</span>.incd_delete(incd_o, dfd);
                    <span class="keyword">break</span>;
                    <span class="keyword">default</span>: 
                    console.log(<span class="string">"ambiguous case"</span>);    
                    dfd.reject(<span class="string">"ambiguous case. None of add, edit , delete!"</span>);
                }    
            <span class="keyword">return</span> dfd.promise();    
        },
        
        incd_add: <span class="keyword">function</span>(incd_o, dfd){</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>console.log(&quot;processing add - &quot;+JSON.stringify(incd_o));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.fetch_from_offline(<span class="keyword">this</span>.get_online_id(incd_o))
                .fail(<span class="keyword">function</span>(error){
                    <span class="keyword">if</span>(error == <span class="string">"Not Found"</span>)
                    {
                        that.fetch_from_online(that.get_online_id(incd_o))
                            .done(<span class="keyword">function</span>(on_model){
                                ConvertNamespace.convert(on_model.toJSON(), that.get_foreign_field_desc(incd_o), <span class="string">"onlinetooffline"</span>)
                                    .done(<span class="keyword">function</span>(on_off_obj){
                                        that.add_offline(on_off_obj.off_json)
                                            .done(<span class="keyword">function</span>(off_model){</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:ADD: Successfully added model in offline db. Added model - &quot;+JSON.stringify(off_model.toJSON()));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                dfd.resolve();
                                            })
                                            .fail(<span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:ADD: Error saving model in offline db - &quot;+error);
console.log(error);
alert(&quot;Unexpected error:INCD:ADD: Error saving new model in offline db - &quot;+error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                dfd.reject(error);
                                            });    
                                    })
                                    .fail(<span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:ADD: Not saving object to offlinedb coz ConvertNamespace failed&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        dfd.reject(error);
                                    });    
                            })
                            .fail(<span class="keyword">function</span>(response){</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>console.log(&quot;INCD: Error fetching model from server - &quot;+response.statusText);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                dfd.reject(response);
                            });
                    }
                })
                .done(<span class="keyword">function</span>(off_model){</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>console.log(&quot;INCD: The model supposed to be added already exists. Moving on...&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.reject(<span class="string">"INCD: The model supposed to be added already exists. Moving on..."</span>);    
                });    
        },    
        
        incd_edit: <span class="keyword">function</span>(incd_o, dfd){</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>console.log(&quot;processing edit - &quot;+JSON.stringify(incd_o));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.fetch_from_offline(<span class="keyword">this</span>.get_online_id(incd_o))
                .done(<span class="keyword">function</span>(off_model){
                    that.fetch_from_online(that.get_online_id(incd_o))
                        .done(<span class="keyword">function</span>(on_model){
                            ConvertNamespace.convert(on_model.toJSON(), that.get_foreign_field_desc(incd_o), <span class="string">"onlinetooffline"</span>)
                                .done(<span class="keyword">function</span>(on_off_obj){
                                    that.edit_offline(off_model, on_off_obj.off_json)
                                        .done(<span class="keyword">function</span>(off_model){</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:EDIT: Successfully edited model in offline db. Edited model - &quot;+JSON.stringify(off_model.toJSON()));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                            dfd.resolve();
                                        })
                                        .fail(<span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:EDIT: Error saving model in offline db. Moving on... - &quot;+error);
alert(&quot;Unexpected error:INCD:EDIT: Error saving new model in offline db. Moving on... - &quot;+error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                            dfd.reject(error);
                                        });    
                                })
                                .fail(<span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:EDIT: Not saving object to offlinedb coz ConvertNamespace failed&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    dfd.reject(error);
                                });    
                        })
                        .fail(<span class="keyword">function</span>(response){</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:EDIT: Error fetching model from server. Moving on... - &quot;+response.statusText);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            dfd.reject(response);
                        });
                })
                .fail(<span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:EDIT: Error fetching model(to be edited) from offline db. Moving on... - &quot;+error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.reject(<span class="string">"Error fetching model(to be edited) from offline db. Moving on..."</span>+error);    
                });    
        },
                
        incd_delete: <span class="keyword">function</span>(incd_o, dfd){
            console.log(<span class="string">"processing delete - "</span>+JSON.stringify(incd_o));
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.fetch_from_offline(<span class="keyword">this</span>.get_online_id(incd_o))
                .done(<span class="keyword">function</span>(off_model){
                    off_model.destroy({
                        success: <span class="keyword">function</span>(){</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:DELETE: Successfully deleted model from offline db.&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            dfd.resolve();
                        },
                        error: <span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:DELETE: Error deleteing model from offline db. Moving on... - &quot;+error);
alert(&quot;Unexpected error:INCD:DELETE: Error deleteing model from offline db. Moving on... - &quot;+error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            dfd.reject();
                        }    
                    })
                })
                .fail(<span class="keyword">function</span>(error){</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>console.log(&quot;INCD:DELETE: Error fetching model(to be deleted) from offline db. Moving on... - &quot;+error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.resolve(error);    
                });    
        },
        
        fetch_from_offline: <span class="keyword">function</span>(online_id){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>console.log(&quot;fetching from offline db&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.offline_model.clear();
            <span class="keyword">this</span>.offline_model.set({online_id:parseInt(online_id)});</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>console.log(this.offline_model.toJSON());</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.offline_model.fetch({
                success: <span class="keyword">function</span>(off_model){</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>console.log(&quot;offline model successfully fetched&quot;);
console.log(off_model);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.resolve(off_model);
                },
                error: <span class="keyword">function</span>(model,error){</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>console.log(&quot;offline model could not be fetched - &quot;+error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.reject(error);
                }    
            });
            <span class="keyword">return</span> dfd.promise();    
        },
          
        fetch_from_online: <span class="keyword">function</span>(online_id){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>console.log(&quot;fetching from online db&quot;);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.online_model.clear();
            <span class="keyword">this</span>.online_model.set(<span class="string">'id'</span>,parseInt(online_id));
            <span class="keyword">this</span>.online_model.fetch({
                success: <span class="keyword">function</span>(on_model,response){</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>console.log(&quot;online model successfully fetched&quot;);
console.log(on_model);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.resolve(on_model);
                },
                error: <span class="keyword">function</span>(model, response, options){</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>console.log(&quot;online model could not be fetched - &quot;+response);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.reject(response);
                }    
            });
            <span class="keyword">return</span> dfd.promise();    
        },
        
        add_offline: <span class="keyword">function</span>(json){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>TODO: convert json online to offline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.offline_model.clear();
            <span class="keyword">this</span>.offline_model.set(json);
            <span class="keyword">this</span>.offline_model.set(<span class="string">'online_id'</span>,parseInt(json.id));
            <span class="keyword">this</span>.offline_model.unset(<span class="string">'id'</span>);  <span class="comment">//new id would be generated, not saving by server id</span>
            <span class="keyword">this</span>.offline_model.save(<span class="literal">null</span>,{
                success: <span class="keyword">function</span>(off_model){
                    dfd.resolve(off_model);
                },
                error: <span class="keyword">function</span>(model,error){</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>console.log(error);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.reject(error);
                }    
            });
            <span class="keyword">return</span> dfd.promise();    
        },
                   
        edit_offline: <span class="keyword">function</span>(off_model, json){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>TODO: convert json online to offline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> offline_id = off_model.get(<span class="string">"id"</span>);
            <span class="keyword">var</span> online_id = json.id;
            off_model.set(json);
            off_model.set(<span class="string">'id'</span>, parseInt(offline_id));
            off_model.set(<span class="string">'online_id'</span>, parseInt(online_id));
            off_model.save(<span class="literal">null</span>,{
                success: <span class="keyword">function</span>(off_model){</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>console.log(off_model);
console.log(online_id);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    dfd.resolve(off_model);
                },
                error: <span class="keyword">function</span>(model,error){
                    dfd.reject(<span class="string">"ERRO EDITING model in IDB: "</span>);
                }    
            });
            <span class="keyword">return</span> dfd.promise();    
        },
        
        finish_download: <span class="keyword">function</span>(last_object_timestamp){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">var</span> that = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>possible if timestamp of last object in incd was not present or no objects were returned</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span>(!last_object_timestamp)
                last_object_timestamp = <span class="keyword">this</span>.start_timestamp;
            
            Offline.fetch_object(<span class="string">"meta_data"</span>, <span class="string">"key"</span>, <span class="string">"last_inc_download"</span>)
                .done(<span class="keyword">function</span>(model){
                    set_timestamp(model);
                })
                .fail(<span class="keyword">function</span>(model, error){
                    set_timestamp(model);
                });
            
            <span class="function"><span class="keyword">function</span> <span class="title">set_timestamp</span><span class="params">(model)</span>{</span>
                model.set(<span class="string">'timestamp'</span>, last_object_timestamp);
                model.save(<span class="literal">null</span>,{
                    success: <span class="keyword">function</span>(){
                        dfd.resolve();
                    },
                    error: <span class="keyword">function</span>(model,error){
                        dfd.reject(<span class="string">"error updating last_full_download in meta_data objectStore"</span>);
                    }
                });
            };
            
            <span class="keyword">return</span> dfd;
        }
        
        

              
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Our module now returns our view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> IncrementalDownloadView;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
