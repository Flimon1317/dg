<!DOCTYPE html>

<html>
<head>
  <title>upload.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="auth.html">
                auth.js
              </a>
            
              
              <a class="source" href="auth_offline_backend.html">
                auth_offline_backend.js
              </a>
            
              
              <a class="source" href="upload_collection.html">
                upload_collection.js
              </a>
            
              
              <a class="source" href="configs.html">
                configs.js
              </a>
            
              
              <a class="source" href="convert_namespace.html">
                convert_namespace.js
              </a>
            
              
              <a class="source" href="denormalize.html">
                denormalize.js
              </a>
            
              
              <a class="source" href="indexeddb_backbone_config.html">
                indexeddb_backbone_config.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="user_model.html">
                user_model.js
              </a>
            
              
              <a class="source" href="offline_utils.html">
                offline_utils.js
              </a>
            
              
              <a class="source" href="online_utils.html">
                online_utils.js
              </a>
            
              
              <a class="source" href="router.html">
                router.js
              </a>
            
              
              <a class="source" href="user_initialize.html">
                user_initialize.js
              </a>
            
              
              <a class="source" href="app_layout.html">
                app_layout.js
              </a>
            
              
              <a class="source" href="dashboard.html">
                dashboard.js
              </a>
            
              
              <a class="source" href="form.html">
                form.js
              </a>
            
              
              <a class="source" href="form_controller.html">
                form_controller.js
              </a>
            
              
              <a class="source" href="full_download.html">
                full_download.js
              </a>
            
              
              <a class="source" href="incremental_download.html">
                incremental_download.js
              </a>
            
              
              <a class="source" href="list.html">
                list.js
              </a>
            
              
              <a class="source" href="login.html">
                login.js
              </a>
            
              
              <a class="source" href="notification.html">
                notification.js
              </a>
            
              
              <a class="source" href="status.html">
                status.js
              </a>
            
              
              <a class="source" href="upload.html">
                upload.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>upload.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define([
  <span class="string">'jquery'</span>,
  <span class="string">'underscore'</span>,
  <span class="string">'layoutmanager'</span>,
  <span class="string">'configs'</span>,
  <span class="string">'views/form'</span>,
  <span class="string">'collections/upload_collection'</span>,
  <span class="string">'convert_namespace'</span>,
  <span class="string">'offline_utils'</span>,
  <span class="string">'online_utils'</span>,
  <span class="string">'indexeddb-backbone'</span>,
  <span class="string">'bootstrapjs'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Using the Require.js text! plugin, we are loaded raw text
which will be used as our views primary template
&#39;text!templates/project/list.html&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>], <span class="keyword">function</span>(jquery,underscore,layoutmanager, configs, Form, upload_collection, ConvertNamespace, Offline, Online){
    
    <span class="keyword">var</span> UploadView = Backbone.Layout.extend({
        
        template: <span class="string">"#upload_template"</span>,
        
        initialize: <span class="keyword">function</span>(){
            console.log(<span class="string">"UPLOAD: initializing new upload view"</span>);
            _(<span class="keyword">this</span>).bindAll(<span class="string">'stop_upload'</span>);
        },      
        
        events:{
            <span class="string">"click #stop_upload"</span>: <span class="string">"stop_upload"</span>
        },
              
        stop_upload: <span class="keyword">function</span>(){
            console.log(<span class="string">"stopping upload"</span>);
            <span class="keyword">this</span>.user_interrupt = <span class="literal">true</span>;
        },
              
        increment_pb: <span class="keyword">function</span>() {
            w = parseFloat(document.getElementById(<span class="string">'pbar'</span>).style.width);
            document.getElementById(<span class="string">'pbar'</span>).style.width= (w + progress_bar_step) +<span class="string">'%'</span>;
        },
        
        update_status: <span class="keyword">function</span>(status){
            $(<span class="string">'#upl_status'</span>).html(status);
        },
        
        update_action: <span class="keyword">function</span>(action){
            $(<span class="string">'#upl_action'</span>).html(action);
        },
              
        initialize_upload: <span class="keyword">function</span>(){
            <span class="keyword">this</span>.user_interrupt = <span class="literal">false</span>;
            <span class="keyword">this</span>.in_progress = <span class="literal">true</span>;
            <span class="keyword">this</span>.$(<span class="string">'#upload_modal'</span>).modal({
                keyboard: <span class="literal">false</span>,
                backdrop: <span class="string">"static"</span>,
            });
            <span class="keyword">this</span>.$(<span class="string">'#upload_modal'</span>).modal(<span class="string">'show'</span>);
            
        },
        
        tear_down: <span class="keyword">function</span>(){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">this</span>.in_progress = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>modal takes time to hide. Need to get the correct point of time when upload has finished.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            $(<span class="string">'#upload_modal'</span>).on(<span class="string">'hidden'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              that.remove();   
              dfd.resolve();
            });
            $(<span class="string">'#upload_modal'</span>).modal(<span class="string">'hide'</span>); 
            <span class="keyword">return</span> dfd.promise();
        },
              
        start_upload: <span class="keyword">function</span>() {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            console.log(<span class="string">"UPLOAD: start the upload"</span>);
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.initialize_upload();
            <span class="keyword">this</span>.get_uploadq()
                .done(<span class="keyword">function</span>(collection){
                    that.iterate_uploadq(collection)
                        .done(<span class="keyword">function</span>(){
                            that.tear_down() <span class="comment">//tear down does not rejects dfd....it may not resolve also!</span>
                                .done(<span class="keyword">function</span>(){
                                    dfd.resolve();
                                });
                        })
                        .fail(<span class="keyword">function</span>(error){
                            that.tear_down()
                                .done(<span class="keyword">function</span>(){
                                    dfd.reject(error);
                                });
                        });
                })
                .fail(<span class="keyword">function</span>(error){
                    that.tear_down()
                        .done(<span class="keyword">function</span>(){
                            dfd.reject(error);
                        });
                });
            <span class="keyword">return</span> dfd;
        },
        
        get_uploadq: <span class="keyword">function</span>(){
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            upload_collection.fetch({
                success: <span class="keyword">function</span>(collection){
                    dfd.resolve(collection);
                },
                error: <span class="keyword">function</span>(error){
                    dfd.reject(error);
                }
            });
            <span class="keyword">return</span> dfd;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>read each entry of the uploadqueue </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        iterate_uploadq: <span class="keyword">function</span>(uploadq) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">this</span>.upload_collection = uploadq;
            console.log(<span class="string">"UPLOAD: inside upload queue: "</span> + <span class="keyword">this</span>.upload_collection.length + <span class="string">" entries"</span>);
            $(<span class="string">'#num_upload'</span>).html(<span class="keyword">this</span>.upload_collection.length);
            progress_bar_step = <span class="number">100</span> / <span class="keyword">this</span>.upload_collection.length;
            <span class="keyword">this</span>.upload_status = {};
            <span class="keyword">this</span>.upload_status[<span class="string">"total"</span>] = <span class="keyword">this</span>.upload_collection.length;
            <span class="keyword">this</span>.upload_status[<span class="string">"uploaded"</span>] = <span class="number">0</span>;
            <span class="keyword">this</span>.pick_next(dfd);
            <span class="keyword">return</span> dfd;
        },

        get_entity_name: <span class="keyword">function</span>(upload_model){
            <span class="keyword">return</span> upload_model.get(<span class="string">'entity_name'</span>)
        },
        
        get_action: <span class="keyword">function</span>(upload_model){
            <span class="keyword">return</span> upload_model.get(<span class="string">'action'</span>);
        },    
        
        get_json: <span class="keyword">function</span>(upload_model){
            <span class="keyword">return</span> upload_model.get(<span class="string">'data'</span>);
        },
        
        get_foreign_field_desc: <span class="keyword">function</span>(upload_model){
            <span class="keyword">var</span> entity_name = <span class="keyword">this</span>.get_entity_name(upload_model);    
            <span class="keyword">if</span>(configs[entity_name].edit)
            {
                <span class="keyword">return</span> configs[entity_name].edit.foreign_entities;
            }
            <span class="keyword">else</span>
                <span class="keyword">return</span> configs[entity_name].foreign_entities;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>returns the offline id of the object to be uploaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get_offline_id: <span class="keyword">function</span>(upload_model){
            <span class="keyword">return</span> parseInt(<span class="keyword">this</span>.get_json(upload_model).id);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>returns the online id of the object to be uploaded</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        get_online_id: <span class="keyword">function</span>(upload_model){
            <span class="keyword">return</span> parseInt(<span class="keyword">this</span>.get_json(upload_model).online_id);
        },

        pick_next: <span class="keyword">function</span>(whole_upload_dfd) {
            console.log(<span class="string">"in pick_next"</span>);
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">this</span>.update_status(<span class="keyword">this</span>.upload_status[<span class="string">"uploaded"</span>]+<span class="string">"/"</span>+<span class="keyword">this</span>.upload_status[<span class="string">"total"</span>]);
            <span class="keyword">this</span>.current_entry = <span class="keyword">this</span>.upload_collection.shift();
            <span class="keyword">if</span> (!<span class="keyword">this</span>.current_entry) {
                <span class="keyword">return</span> whole_upload_dfd.resolve();
            }
            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.user_interrupt)
            {
                <span class="keyword">this</span>.upload_collection.unshift(<span class="keyword">this</span>.current_entry);
                <span class="keyword">return</span> whole_upload_dfd.reject(<span class="string">"User stopped Sync"</span>);
            }
            <span class="keyword">else</span>{
                <span class="keyword">this</span>.process_upload_entry(<span class="keyword">this</span>.current_entry)
                    .fail(<span class="keyword">function</span>(error){
                        console.log(<span class="string">"FAILED TO UPLOAD AN OBJECT: "</span>);
                        console.log(error);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>object to be uploaded doesn&#39;t exists in offline anymore
ConvertNamespace failed
online_id couldn&#39;t be injected
The object discarded in upload error form could not be deleted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    })
                    .done(<span class="keyword">function</span>(){
                        console.log(<span class="string">"SUCESSFULLY UPLOADED AN OBJECT"</span>);
                    })
                    .always(<span class="keyword">function</span>(){
                        that.current_entry.destroy();
                        that.increment_pb();
                        that.upload_status[<span class="string">"uploaded"</span>]++;
                        that.pick_next(whole_upload_dfd);
                    });
            }

        },
        
        process_upload_entry: <span class="keyword">function</span>(up_entry) {
            <span class="keyword">var</span> dfd = <span class="keyword">new</span> $.Deferred();
            <span class="keyword">this</span>.update_action(<span class="string">"Uploading "</span>+<span class="keyword">this</span>.get_entity_name(up_entry));
            
            <span class="keyword">switch</span>(<span class="keyword">this</span>.get_action(up_entry))
                {
                    <span class="keyword">case</span> <span class="string">'A'</span>: 
                        <span class="keyword">this</span>.upload_add_edit(up_entry, dfd);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'E'</span>: 
                        <span class="keyword">this</span>.upload_add_edit(up_entry, dfd);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'D'</span>: 
                        <span class="keyword">this</span>.upload_delete(up_entry, dfd);
                        <span class="keyword">break</span>;
                    <span class="keyword">default</span>: 
                        console.log(<span class="string">"ambiguous case"</span>);    
                        dfd.reject(<span class="string">"UPLOAD:UNEXPECTED ERROR: Ambiguous case. None of add, edit , delete!"</span>);
                }    
            <span class="keyword">return</span> dfd.promise();    
            
        },
            
        upload_add_edit: <span class="keyword">function</span>(up_model, dfd) {
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            Offline.fetch_object(<span class="keyword">this</span>.get_entity_name(up_model), <span class="string">"id"</span>, <span class="keyword">this</span>.get_offline_id(up_model))  
                .done(<span class="keyword">function</span>(off_model){
                    console.log(<span class="string">"Off model fetched - "</span>+JSON.stringify(off_model.toJSON()));
                    ConvertNamespace.convert(that.get_json(up_model), that.get_foreign_field_desc(up_model), <span class="string">"offlinetoonline"</span>)
                        .done(<span class="keyword">function</span>(on_off_obj){
                            <span class="keyword">if</span>(that.get_action(up_model) == <span class="string">"A"</span>)
                                {
                                    <span class="keyword">delete</span> on_off_obj.on_json.id;
                                }
                                <span class="keyword">else</span>
                                {
                                    on_off_obj.on_json.id = parseInt(off_model.get(<span class="string">"online_id"</span>)); 
                                    <span class="keyword">delete</span> on_off_obj.on_json.online_id;
                                }
                            Online.save(<span class="literal">null</span>, that.get_entity_name(up_model), on_off_obj.on_json)
                                .done(<span class="keyword">function</span>(on_model){
                                    console.log(<span class="string">"INCD:ADD: Successfully uploaded model. uploaded model - "</span>+JSON.stringify(on_model.toJSON()));
                                    <span class="keyword">var</span> off_json = off_model.toJSON();
                                    off_json.online_id = parseInt(on_model.get(<span class="string">"id"</span>));
                                    Offline.save(off_model, that.get_entity_name(up_model), off_json)
                                        .done(<span class="keyword">function</span>(off_model){
                                            console.log(<span class="string">"OFF model after all upload - "</span>+JSON.stringify(off_model.toJSON()));
                                            dfd.resolve();    
                                        })
                                        .fail(<span class="keyword">function</span>(error){
                                            dfd.reject(<span class="string">"UPLOAD: Error saving online_id in offline obj: "</span>+error);
                                        });
                                })
                                .fail(<span class="keyword">function</span>(error){
                                    console.log(<span class="string">"Error while saving oject on server"</span>);
                                    that.curr_entry_dfd = dfd;
                                    that.show_form(that.get_entity_name(up_model), on_off_obj.off_json, error.responseText);
                                });    
                        })
                        .fail(<span class="keyword">function</span>(model, error){
                            console.log(<span class="string">"UPLOAD: Not uploading object coz ConvertNamespace failed"</span>);
                            dfd.reject(error);
                        });    
                })
                .fail(<span class="keyword">function</span>(error){
                    <span class="keyword">if</span>(error == <span class="string">"Not Found"</span>)
                    {
                        <span class="keyword">return</span> dfd.reject(<span class="string">"The object to be uploaded doesn't exists anymore."</span>)    
                    }
                    <span class="keyword">else</span>
                        dfd.reject(error);
                });    
        },
        
        show_form: <span class="keyword">function</span>(entity_name, json, err_msg){
            console.log(<span class="string">"UPLOAD:ERROR: need to show this json -"</span> + JSON.stringify(json));
            p = <span class="keyword">new</span> Form({
                serialize: {
                    button1: <span class="string">"Save again"</span>,
                    button2: <span class="string">"Discard"</span>
                },
                entity_name: entity_name,
                model_json: json
            });
            p.render();
            <span class="keyword">this</span>.listenTo(p, <span class="string">'save_clicked'</span>, <span class="keyword">this</span>.after_upload_error_save_again);
            <span class="keyword">this</span>.listenTo(p, <span class="string">'button2_clicked'</span>, <span class="keyword">this</span>.after_upload_error_discard);
            p.show_errors(err_msg);
            <span class="keyword">this</span>.$(<span class="string">'#upload_form'</span>)
                .html(p.el);
        },
        
        after_upload_error_save_again: <span class="keyword">function</span>(e){
            console.log(<span class="string">"UPLOAD:ERROR: edit and retry"</span>);
            console.log(<span class="string">"UPLOAD:ERROR: json from form - "</span> + JSON.stringify(e.context.final_json));
            <span class="keyword">var</span> after_upload_error_json = e.context.final_json;
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            Offline.save(<span class="literal">null</span>, <span class="keyword">this</span>.get_entity_name(<span class="keyword">this</span>.current_entry), after_upload_error_json)
                .done(<span class="keyword">function</span>(off_model){
                    that.$(<span class="string">'#upload_form'</span>)
                        .empty();
                    that.current_entry.set(<span class="string">'data'</span>, after_upload_error_json);
                    that.upload_add_edit(that.current_entry, that.curr_entry_dfd);
                })
                .fail(<span class="keyword">function</span>(error){
                    e.context.show_errors(error);
                });
        },
        
        after_upload_error_discard: <span class="keyword">function</span>(e){
            console.log(<span class="string">"DISCARD"</span>);
            <span class="keyword">var</span> that = <span class="keyword">this</span>;
            <span class="keyword">if</span> (<span class="keyword">this</span>.get_action(<span class="keyword">this</span>.current_entry) == <span class="string">"A"</span>) 
            {
                Offline.delete_object(<span class="literal">null</span>, <span class="keyword">this</span>.get_entity_name(<span class="keyword">this</span>.current_entry), <span class="keyword">this</span>.get_offline_id(<span class="keyword">this</span>.current_entry))
                    .done(<span class="keyword">function</span>(){
                        <span class="keyword">return</span> that.curr_entry_dfd.resolve();
                    })
                    .fail(<span class="keyword">function</span>(error){
                        <span class="keyword">return</span> that.curr_entry_dfd.reject(<span class="string">"The object discarded in upload error form could not be deleted - "</span>+error);
                    });
            } 
            <span class="keyword">else</span> 
            {
                <span class="keyword">this</span>.curr_entry_dfd.resolve();
            }
            <span class="keyword">this</span>.$(<span class="string">'#upload_form'</span>)
                .html(<span class="string">""</span>);
        },
        
        upload_delete: <span class="keyword">function</span>(up_model, dfd) {
            <span class="keyword">if</span>(<span class="keyword">this</span>.get_online_id(up_model))
            {
                Online.delete_object(<span class="literal">null</span>, <span class="keyword">this</span>.get_entity_name(up_model), <span class="keyword">this</span>.get_online_id(up_model))
                    .done(<span class="keyword">function</span>(){
                        <span class="keyword">return</span> dfd.resolve();
                    })
                    .fail(<span class="keyword">function</span>(error){
                        <span class="keyword">return</span> dfd.reject(<span class="string">"The object discarded in upload error form could not be deleted - "</span>+error);
                    });
            }
            <span class="keyword">else</span>
            {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>No online_id was found on the model when deleted. Therefore its not on server yet. Hence taking no action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> dfd.resolve();
            }
        },

              
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Our module now returns our view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">return</span> UploadView;
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
